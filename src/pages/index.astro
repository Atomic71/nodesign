---
import Layout from '@layouts/Layout.astro';
import Hero from '@components/home/Hero.astro';
import FeaturedProjectsSection from '@components/home/FeaturedProjectsSection.astro';
import AboutSection from '@components/home/AboutSection.astro';
import TestimonialsSection from '@components/home/TestimonialsSection.astro';
import ServicesSection from '@components/home/ServicesSection.astro';
import CtaSection from '@components/home/CtaSection.astro';
import { getCategories } from '@utils/images';
import { getCollection } from 'astro:content';

export const prerender = true;

// Fetch all necessary data at build time
const categories = await getCategories();
const homeContent = await getCollection('home');

if (!homeContent) {
  return Astro.redirect('/404');
}

const featuredProjects = categories
  .map((category) => ({
    category: category.name,
    categorySlug: category.slug,
    project: category.projects[0],
  }))
  .filter((item) => item.project);

const homeData = homeContent[0].data;
---

<Layout>
  <Hero slides={homeData.carouselSlides} />
  <ServicesSection
    title={homeData.services.title}
    description={homeData.services.description}
    categories={categories}
  />
  <FeaturedProjectsSection
    title={homeData.featuredProjects.title}
    description={homeData.featuredProjects.description}
    featuredProjects={featuredProjects}
  />

  <AboutSection
    title={homeData.about.title}
    description={homeData.about.description}
    cta={homeData.about.cta}
  />

  <TestimonialsSection
    title={homeData.testimonials.title}
    testimonials={homeData.testimonials.items}
  />

  <CtaSection
    title={homeData.cta.title}
    description={homeData.cta.description}
    buttonText={homeData.cta.buttonText}
    link={homeData.cta.link}
  />
</Layout>
